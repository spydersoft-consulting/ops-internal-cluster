loki:
  global:
    dnsService: rke2-coredns-rke2-coredns
    dnsNamespace: kube-system
  loki:
    storage:
      bucketNames:
        chunks: loki-chunks
        ruler: loki-ruler
        admin: loki-admin
      type: s3
      s3:
        accessKeyId: ${STORAGE_USERNAME}
        secretAccessKey: ${STORAGE_PASSWORD}
        region: us-east-1
        endpoint: http://cloud.gerega.net:3900
        s3ForcePathStyle: true
        insecure: true
    auth_enabled: true
    structuredConfig:
      # Runtime configuration for per-tenant overrides
      runtime_config:
        file: /etc/loki/runtime-overrides/runtime-overrides.yaml
        period: 10s

      # Compactor configuration (replaces table_manager for TSDB)
      compactor:
        working_directory: /var/loki/compactor
        compaction_interval: 10m
        retention_enabled: true
        retention_delete_delay: 2h
        retention_delete_worker_count: 150
        delete_request_store: s3

      schema_config:
        configs:
          # Single schema config for new installation - start fresh with TSDB
          - from: 2024-12-10
            store: tsdb
            object_store: s3
            schema: v13
            index:
              prefix: index_
              period: 24h

      limits_config:
        allow_structured_metadata: true
        retention_period: 720h  # 30 days default (overridden per-tenant via runtime config)
        # Per-stream retention overrides (for specific namespaces)
        retention_stream:
          - selector: '{namespace="argocd"}'
            priority: 1
            period: 24h
        
    rulerConfig:
      alertmanager_url: https://mimir.mattgerega.net
      enable_alertmanager_v2: true
  minio:
    enabled: false
  write:
    replicas: 3
    extraArgs:
      - -config.expand-env=true
    extraEnvFrom:
      - secretRef:
          name: loki-storage-secret
    extraVolumes:
      - name: runtime-overrides
        configMap:
          name: loki-runtime-overrides
    extraVolumeMounts:
      - name: runtime-overrides
        mountPath: /etc/loki/runtime-overrides
        readOnly: true
    persistence:
      enabled: true
      storageClass: nfs-client
      size: 10Gi
  read:
    replicas: 3
    extraArgs:
      - -config.expand-env=true
    extraEnvFrom:
      - secretRef:
          name: loki-storage-secret
    extraVolumes:
      - name: runtime-overrides
        configMap:
          name: loki-runtime-overrides
    extraVolumeMounts:
      - name: runtime-overrides
        mountPath: /etc/loki/runtime-overrides
        readOnly: true
    persistence:
      enabled: true
      storageClass: nfs-client
      size: 10Gi
  backend:
    replicas: 3
    extraArgs:
      - -config.expand-env=true
    extraEnvFrom:
      - secretRef:
          name: loki-storage-secret
    extraVolumes:
      - name: runtime-overrides
        configMap:
          name: loki-runtime-overrides
    extraVolumeMounts:
      - name: runtime-overrides
        mountPath: /etc/loki/runtime-overrides
        readOnly: true
    persistence:
      enabled: true
      storageClass: nfs-client
      size: 10Gi
  gateway:
    replicas: 1
    autoscaling:
      enabled: false
    service:
      labels:
        mirror.linkerd.io/exported: "true"
    ingress:
      enabled: false  # Migrated to Gateway API HTTPRoute
      hosts:
        - host: "loki.mattgerega.net"
          paths:
            - path: /
              pathType: Prefix
      annotations:
        kubernetes.io/ingress.class: nginx
        nginx.ingress.kubernetes.io/service-upstream: "true"
      tls: []
  tableManager:
    enabled: false
  test:
    enabled: false
  chunksCache:
    enabled: false
serviceMonitor:
  enabled: true
  interval: 1m
  scrapeTimeout: 30s
